<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Lab - √(Raiz) Cuadrada²</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600;700&display=swap');

        body { background: white; font-family: 'Open Sans', sans-serif; display: flex; justify-content: center; padding: 20px; color: #333; }
        .container { max-width: 1100px; width: 100%; padding: 40px; background: #F2F2F2; border-radius: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin: 0; font-family: 'Playfair Display', serif; }
        .header p { font-size: 18px; font-weight: 600; font-family: 'Playfair Display', serif; margin: 5px 0; }

        /* GESTIÓN DE MATRICES */
        .matrix-manager { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; justify-content: center; }
        .matrix-card { background: white; padding: 20px; border-radius: 25px; border: 1px solid #ddd; min-width: 250px; position: relative; }
        .matrix-name { font-family: 'Playfair Display'; font-size: 24px; font-weight: 700; position: absolute; top: 15px; left: 20px; }
        .matrix-controls { text-align: right; margin-bottom: 15px; }
        .matrix-controls input { width: 45px; padding: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: center; }
        
        .matrix-input-grid { display: grid; gap: 5px; justify-content: center; margin-top: 10px; }
        .matrix-input-grid input { width: 50px; height: 40px; text-align: center; border-radius: 10px; border: 1px solid #eee; background: #f9f9f9; font-weight: 600; }

        /* OPERACIONES */
        .ops-section { background: white; padding: 25px; border-radius: 30px; border: 1px solid #ddd; margin-bottom: 30px; }
        .pill-input { width: 100%; padding: 15px 25px; border-radius: 50px; border: 1px solid #ccc; font-size: 16px; font-family: 'Open Sans'; font-weight: 600; box-sizing: border-box; }
        .btn-calc { width: 100%; padding: 15px; background: black; color: white; border: none; border-radius: 30px; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        .btn-calc:hover { transform: scale(1.02); }

        /* RESULTADOS */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .res-card { background: white; padding: 20px; border-radius: 25px; border: 1px solid #ddd; }
        .res-card h3 { font-size: 14px; color: #888; text-transform: uppercase; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .res-content { font-family: 'Open Sans'; font-weight: 700; overflow-x: auto; }

        /* GRÁFICAS */
        .graph-box { background: white; border-radius: 30px; border: 1px solid #ddd; height: 500px; position: relative; overflow: hidden; }
        .graph-nav { position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; gap: 10px; }
        .pill-btn { border: none; padding: 8px 20px; border-radius: 40px; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; background: #e0e0e0; color: #666; }
        .pill-btn.active { background: black; color: white; }

        /* BOTÓN DESCARGA */
        .download-container { display: flex; justify-content: center; margin-top: 25px; }
        .btn-download-pill { background: white; border: 1px solid #e0e0e0; border-radius: 50px; padding: 12px 35px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.3s ease; font-family: 'Open Sans'; font-weight: 700; font-size: 15px; color: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .btn-download-pill:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .btn-download-pill svg { width: 20px; height: 20px; }

        .matrix-btn-add { background: #ddd; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Laboratorio de Matrices Avanzado</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div class="matrix-manager" id="manager">
        </div>
    <div style="text-align: center; margin-bottom: 30px;">
        <button class="matrix-btn-add" onclick="addNewMatrix()" title="Añadir Matriz">+</button>
    </div>

    <div class="ops-section">
        <h3 style="font-size: 14px; color: #888; margin-top: 0;">OPERACIONES Y SISTEMAS</h3>
        <input type="text" id="op-input" class="pill-input" placeholder="Ejemplo: A + B , A * B , Det(A) + Det(B) , Rango(A)">
        <p style="font-size: 11px; color: #999; margin: 10px 0 0 15px;">Para resolver sistemas, use: Resolver(A, B) donde B es el vector de términos independientes.</p>
        <button class="btn-calc" onclick="calculateAll()">Calcular y Analizar</button>
    </div>

    <div class="results-grid" id="results">
        </div>

    <div class="graph-box">
        <div class="graph-nav">
            <button id="btn-2d" class="pill-btn active" onclick="setGraphMode('2d')">Determinante 2D (Área)</button>
            <button id="btn-3d" class="pill-btn" onclick="setGraphMode('3d')">Determinante 3D (Volumen)</button>
        </div>
        <div id="plot" style="width:100%; height:100%;"></div>
    </div>

    <div class="download-container">
        <button class="btn-download-pill" onclick="downloadResult()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Descargar Análisis PNG
        </button>
    </div>
</div>

<script>
    let matrixCount = 0;
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let graphMode = '2d';
    const watermarkText = "√(Raiz) Cuadrada²";

    function addNewMatrix() {
        if (matrixCount >= 26) return;
        const name = alphabet[matrixCount];
        const id = `matrix-${name}`;
        
        const card = document.createElement('div');
        card.className = 'matrix-card';
        card.id = id;
        card.innerHTML = `
            <div class="matrix-name">${name}</div>
            <div class="matrix-controls">
                <input type="number" value="2" min="1" max="6" id="r-${name}" onchange="renderGrid('${name}')"> x 
                <input type="number" value="2" min="1" max="6" id="c-${name}" onchange="renderGrid('${name}')">
            </div>
            <div id="grid-${name}" class="matrix-input-grid"></div>
        `;
        document.getElementById('manager').appendChild(card);
        renderGrid(name);
        matrixCount++;
    }

    function renderGrid(name) {
        const r = parseInt(document.getElementById(`r-${name}`).value);
        const c = parseInt(document.getElementById(`c-${name}`).value);
        const grid = document.getElementById(`grid-${name}`);
        grid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
        
        let html = '';
        for (let i = 0; i < r * c; i++) {
            html += `<input type="number" value="${Math.floor(Math.random()*5)}" class="val-${name}">`;
        }
        grid.innerHTML = html;
    }

    function getMatrixData(name) {
        const r = parseInt(document.getElementById(`r-${name}`).value);
        const c = parseInt(document.getElementById(`c-${name}`).value);
        const inputs = document.querySelectorAll(`.val-${name}`);
        let data = [];
        for (let i = 0; i < r; i++) {
            let row = [];
            for (let j = 0; j < c; j++) {
                row.push(parseFloat(inputs[i * c + j].value) || 0);
            }
            data.push(row);
        }
        return data;
    }

    // ÁLGEBRA LINEAL
    const Linear = {
        transpose: (m) => m[0].map((_, i) => m.map(row => row[i])),
        det: (m) => {
            if (m.length !== m[0].length) return null;
            if (m.length === 1) return m[0][0];
            if (m.length === 2) return m[0][0]*m[1][1] - m[0][1]*m[1][0];
            return m[0].reduce((d, c, i) => d + (i % 2 ? -1 : 1) * c * Linear.det(m.slice(1).map(row => row.filter((_, j) => j !== i))), 0);
        },
        rank: (m) => {
            let matrix = m.map(r => [...r]);
            let rows = matrix.length;
            let cols = matrix[0].length;
            let rank = 0;
            let pivotRow = 0;
            for (let j = 0; j < cols && pivotRow < rows; j++) {
                let max = pivotRow;
                for (let i = pivotRow + 1; i < rows; i++) {
                    if (Math.abs(matrix[i][j]) > Math.abs(matrix[max][j])) max = i;
                }
                if (Math.abs(matrix[max][j]) > 1e-9) {
                    [matrix[pivotRow], matrix[max]] = [matrix[max], matrix[pivotRow]];
                    for (let i = pivotRow + 1; i < rows; i++) {
                        let multiplier = matrix[i][j] / matrix[pivotRow][j];
                        for (let k = j; k < cols; k++) matrix[i][k] -= multiplier * matrix[pivotRow][k];
                    }
                    pivotRow++;
                    rank++;
                }
            }
            return rank;
        },
        ref: (m) => {
            let matrix = m.map(r => [...r]);
            // Versión simplificada de eliminación Gaussiana
            let rows = matrix.length; let cols = matrix[0].length;
            let pivot = 0;
            for(let j=0; j<cols && pivot<rows; j++){
                let sel = pivot;
                for(let i=pivot+1; i<rows; i++) if(Math.abs(matrix[i][j]) > Math.abs(matrix[sel][j])) sel = i;
                [matrix[pivot], matrix[sel]] = [matrix[sel], matrix[pivot]];
                if(Math.abs(matrix[pivot][j]) < 1e-9) continue;
                for(let i=pivot+1; i<rows; i++){
                    let factor = matrix[i][j]/matrix[pivot][j];
                    for(let k=j; k<cols; k++) matrix[i][k] -= factor * matrix[pivot][k];
                }
                pivot++;
            }
            return matrix;
        }
    };

    function setGraphMode(mode) {
        graphMode = mode;
        document.getElementById('btn-2d').classList.toggle('active', mode === '2d');
        document.getElementById('btn-3d').classList.toggle('active', mode === '3d');
        calculateAll();
    }

    function calculateAll() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        const matrices = {};
        for(let i=0; i<matrixCount; i++) {
            const name = alphabet[i];
            matrices[name] = getMatrixData(name);
        }

        // Analizar cada matriz individualmente
        Object.keys(matrices).forEach(name => {
            const m = matrices[name];
            const det = Linear.det(m);
            const rank = Linear.rank(m);
            const tri = Linear.ref(m);

            const card = document.createElement('div');
            card.className = 'res-card';
            card.innerHTML = `
                <h3>Propiedades de ${name}</h3>
                <div class="res-content">
                    Determinante: ${det !== null ? det.toFixed(2) : 'No cuadrada'}<br>
                    Rango: ${rank}<br>
                    Triangular:<br>
                    <small>${tri.map(r => r.map(v => v.toFixed(1)).join(' | ')).join('<br>')}</small>
                </div>
            `;
            resultsDiv.appendChild(card);
        });

        drawGraph(matrices['A'] || [[1,0],[0,1]]);
    }

    function drawGraph(m) {
        const traces = [];
        if (graphMode === '2d') {
            // Representación como paralelogramo (Imagen 2)
            const v1 = [m[0][0] || 0, m[1] ? m[1][0] : 0];
            const v2 = [m[0][1] || 0, m[1] ? m[1][1] : 0];
            
            traces.push({
                x: [0, v1[0], v1[0]+v2[0], v2[0], 0],
                y: [0, v1[1], v1[1]+v2[1], v2[1], 0],
                fill: 'toself', type: 'scatter', mode: 'lines+markers',
                fillcolor: 'rgba(255, 105, 180, 0.3)',
                line: {color: 'black', width: 2},
                name: 'Área (Det)'
            });
        } else {
            // Representación 3D (Paralelepípedo)
            const v1 = [m[0][0]||0, (m[1]?m[1][0]:0), (m[2]?m[2][0]:0)];
            const v2 = [m[0][1]||0, (m[1]?m[1][1]:0), (m[2]?m[2][1]:0)];
            const v3 = [m[0][2]||0, (m[1]?m[1][2]:0), (m[2]?m[2][2]:0)];

            const pts = [
                [0,0,0], v1, v2, v3,
                [v1[0]+v2[0], v1[1]+v2[1], v1[2]+v2[2]],
                [v1[0]+v3[0], v1[1]+v3[1], v1[2]+v3[2]],
                [v2[0]+v3[0], v2[1]+v3[1], v2[2]+v3[2]],
                [v1[0]+v2[0]+v3[0], v1[1]+v2[1]+v3[1], v1[2]+v2[2]+v3[2]]
            ];

            traces.push({
                type: 'scatter3d', mode: 'lines',
                x: [0, v1[0], pts[4][0], v2[0], 0, v3[0], pts[5][0], pts[7][0], pts[6][0], v3[0]],
                y: [0, v1[1], pts[4][1], v2[1], 0, v3[1], pts[5][1], pts[7][1], pts[6][1], v3[1]],
                z: [0, v1[2], pts[4][2], v2[2], 0, v3[2], pts[5][2], pts[7][2], pts[6][2], v3[2]],
                line: {color: 'black', width: 4}
            });
        }

        const layout = {
            margin: {l:0, r:0, t:0, b:0},
            showlegend: false,
            paper_bgcolor: 'white',
            annotations: [{
                text: watermarkText, xref: "paper", yref: "paper", x: 0.95, y: 0.05,
                showarrow: false, font: { family: "Playfair Display", size: 16, color: "#ddd", weight: "bold" }
            }]
        };
        Plotly.newPlot('plot', traces, layout, {responsive: true, displayModeBar: false});
    }

    async function downloadResult() {
        const plot = document.getElementById('plot');
        await Plotly.relayout(plot, {
            'annotations[0].font.size': 50,
            'annotations[0].font.color': 'rgba(0,0,0,0.1)'
        });
        await Plotly.downloadImage(plot, {
            format: 'png', width: 1200, height: 900,
            filename: 'analisis_matricial_raiz_cuadrada'
        });
        Plotly.relayout(plot, {
            'annotations[0].font.size': 16,
            'annotations[0].font.color': '#ddd'
        });
    }

    window.onload = () => { addNewMatrix(); addNewMatrix(); calculateAll(); };
</script>
</body>
</html>
