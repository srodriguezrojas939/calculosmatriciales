<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo Matriciales - √(Raiz) Cuadrada²</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap');

        :root {
            --bg-gray: #F2F2F2;
            --white: #FFFFFF;
            --black: #000000;
            --border: #DDDDDD;
            --text-gray: #666666;
        }

        body { 
            background: white; 
            font-family: 'Open Sans', sans-serif; 
            margin: 0;
            display: flex; 
            justify-content: center; 
            padding: 15px; 
            color: #333;
        }

        .container { 
            max-width: 1000px; 
            width: 100%; 
            padding: 30px; 
            background: var(--bg-gray); 
            border-radius: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); 
        }

        /* TIPOGRAFÍA */
        h1, h2, h3, .matrix-name { font-family: 'Playfair Display', serif; font-weight: 700; }
        p, span, div, input, button { font-family: 'Open Sans', sans-serif; font-weight: 400; }
        .bold { font-weight: 600; }

        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 34px; margin: 0; }
        .header p { font-size: 18px; font-weight: 700; font-family: 'Playfair Display'; margin: 5px 0; }

        /* GESTIÓN DE MATRICES */
        .matrix-manager { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }

        .matrix-card { 
            background: var(--white); 
            padding: 20px; 
            border-radius: 30px; 
            border: 1px solid var(--border); 
            position: relative;
            transition: 0.3s;
        }

        .matrix-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .matrix-name { font-size: 26px; }
        
        .btn-delete { 
            background: #ffeded; color: #ff4d4d; border: none; 
            width: 28px; height: 28px; border-radius: 50%; 
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;
        }

        .matrix-controls { display: flex; gap: 8px; align-items: center; margin-bottom: 15px; font-size: 13px; }
        .matrix-controls input { 
            width: 40px; padding: 4px; border-radius: 8px; border: 1px solid #eee; text-align: center; font-weight: 600;
        }

        .matrix-grid { display: grid; gap: 6px; justify-content: center; }
        .matrix-grid input { 
            width: 55px; height: 45px; text-align: center; border-radius: 12px; 
            border: 1px solid #f0f0f0; background: #fafafa; font-weight: 600; font-size: 15px;
        }

        /* SECCIÓN OPERACIONES */
        .ops-section { background: var(--white); padding: 25px; border-radius: 35px; border: 1px solid var(--border); margin-bottom: 30px; }
        .pill-input { 
            width: 100%; padding: 18px 25px; border-radius: 50px; border: 1px solid #e0e0e0; 
            font-size: 16px; font-weight: 600; box-sizing: border-box; outline: none; transition: 0.3s;
        }
        .pill-input:focus { border-color: var(--black); box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }

        .btn-main { 
            width: 100%; padding: 18px; background: var(--black); color: var(--white); 
            border: none; border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.3s; 
        }

        /* RESULTADOS */
        .res-container { margin-bottom: 30px; }
        .res-card { background: var(--white); padding: 25px; border-radius: 30px; border: 2px solid var(--black); margin-top: 10px; }
        .res-card h2 { margin-top: 0; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .res-content { font-size: 18px; font-weight: 600; overflow-x: auto; }

        /* GRÁFICAS */
        .graph-wrapper { background: var(--white); border-radius: 40px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 30px; position: relative; }
        .graph-tools { 
            padding: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; 
            border-bottom: 1px solid #f0f0f0; background: #fafafa;
        }
        .select-pill { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; background: white; font-weight: 600; outline: none; cursor: pointer; }
        
        #plot { height: 500px; width: 100%; }

        /* BOTONES ACCIÓN */
        .action-bar { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .pill-btn-white { 
            background: var(--white); border: 1px solid #e0e0e0; border-radius: 50px; 
            padding: 12px 30px; display: flex; align-items: center; gap: 10px; 
            cursor: pointer; font-weight: 700; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .pill-btn-white:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.06); }

        /* MODAL GUÍA */
        #guide-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content { 
            background: white; padding: 40px; border-radius: 40px; max-width: 600px; width: 100%; 
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .close-modal { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 24px; font-weight: bold; }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 600px) {
            .container { padding: 20px; border-radius: 30px; }
            .header h1 { font-size: 26px; }
            .matrix-grid input { width: 45px; height: 40px; font-size: 13px; }
            .pill-input { padding: 15px; font-size: 14px; }
            #plot { height: 350px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Cálculo Matriciales</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div class="matrix-manager" id="manager"></div>
    
    <div style="text-align: center; margin-bottom: 25px;">
        <button class="pill-btn-white" onclick="addNewMatrix()" style="margin: 0 auto;">+ Añadir Matriz</button>
    </div>

    <div class="ops-section">
        <input type="text" id="op-input" class="pill-input" placeholder="A + B,  A * B,  Inv(A), Det(A)...">
        <button class="btn-main" onclick="executeCalculation()">Calcular Resultado</button>
    </div>

    <div class="res-container" id="res-section" style="display: none;">
        <div class="res-card">
            <h2>Resultado Final</h2>
            <div id="res-data" class="res-content"></div>
        </div>
    </div>

    <div class="graph-wrapper">
        <div class="graph-tools">
            <span class="bold">Visualizar:</span>
            <select id="graph-select" class="select-pill" onchange="updateView()"></select>
            <select id="graph-type" class="select-pill" onchange="updateView()">
                <option value="2d">Determinante 2D</option>
                <option value="3d" selected>Determinante 3D</option>
            </select>
        </div>
        <div id="plot"></div>
    </div>

    <div class="action-bar">
        <button class="pill-btn-white" onclick="downloadPNG()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Descargar PNG
        </button>
        <button class="pill-btn-white" onclick="toggleGuide(true)">Guía de uso</button>
    </div>
</div>

<div id="guide-modal" onclick="toggleGuide(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="toggleGuide(false)">&times;</span>
        <h2>Guía de Uso</h2>
        <p>Bienvenido al laboratorio avanzado. Aquí tienes los comandos disponibles:</p>
        <ul style="line-height: 1.8;">
            <li><span class="bold">A + B</span> : Suma de matrices.</li>
            <li><span class="bold">A - B</span> : Resta de matrices.</li>
            <li><span class="bold">A * B</span> : Multiplicación matricial.</li>
            <li><span class="bold">Inv(A)</span> : Calcula la inversa (si el determinante ≠ 0).</li>
            <li><span class="bold">Det(A)</span> : Halla el determinante.</li>
            <li><span class="bold">Trans(A)</span> : Transpuesta de la matriz.</li>
            <li><span class="bold">Rango(A)</span> : Calcula el rango.</li>
            <li><span class="bold">Resolver(A, B)</span> : Resuelve AX = B.</li>
        </ul>
        <p><small>* La matriz A es obligatoria y no puede eliminarse.</small></p>
    </div>
</div>

<script>
    let matrices = {};
    let matrixNames = ["A"];
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let lastResult = null;

    function init() {
        addNewMatrix("A");
        addNewMatrix("B");
        executeCalculation();
    }

    function addNewMatrix(fixedName = null) {
        const name = fixedName || alphabet[matrixNames.length];
        if (matrixNames.includes(name) && !fixedName) return;
        if (!fixedName) matrixNames.push(name);

        const manager = document.getElementById('manager');
        const card = document.createElement('div');
        card.className = 'matrix-card';
        card.id = `card-${name}`;
        
        const deleteBtn = name === "A" ? "" : `<button class="btn-delete" onclick="removeMatrix('${name}')">&times;</button>`;

        card.innerHTML = `
            <div class="matrix-header">
                <div class="matrix-name">${name}</div>
                ${deleteBtn}
            </div>
            <div class="matrix-controls">
                <input type="number" value="3" min="1" max="6" id="r-${name}" onchange="renderGrid('${name}')"> x 
                <input type="number" value="3" min="1" max="6" id="c-${name}" onchange="renderGrid('${name}')">
                <span>Tamaño</span>
            </div>
            <div id="grid-${name}" class="matrix-grid"></div>
        `;
        manager.appendChild(card);
        renderGrid(name);
        updateSelects();
    }

    function removeMatrix(name) {
        matrixNames = matrixNames.filter(n => n !== name);
        document.getElementById(`card-${name}`).remove();
        updateSelects();
    }

    function renderGrid(name) {
        const r = document.getElementById(`r-${name}`).value;
        const c = document.getElementById(`c-${name}`).value;
        const grid = document.getElementById(`grid-${name}`);
        grid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
        
        let html = '';
        for (let i = 0; i < r * c; i++) {
            const val = (i % (parseInt(c)+1) === 0) ? 1 : 0; // Identidad por defecto
            html += `<input type="number" value="${val}" class="val-${name}">`;
        }
        grid.innerHTML = html;
    }

    function getMatrixData(name) {
        const r = parseInt(document.getElementById(`r-${name}`).value);
        const c = parseInt(document.getElementById(`c-${name}`).value);
        const inputs = document.querySelectorAll(`.val-${name}`);
        let data = [];
        for (let i = 0; i < r; i++) {
            let row = [];
            for (let j = 0; j < c; j++) row.push(parseFloat(inputs[i * c + j].value) || 0);
            data.push(row);
        }
        return data;
    }

    function updateSelects() {
        const sel = document.getElementById('graph-select');
        const current = sel.value;
        sel.innerHTML = matrixNames.map(n => `<option value="${n}">Matriz ${n}</option>`).join('');
        sel.innerHTML += `<option value="RES">Resultado</option>`;
        if (current) sel.value = current;
    }

    // OPERACIONES MATRICIALES BÁSICAS
    const MathOps = {
        add: (A, B) => A.map((r, i) => r.map((v, j) => v + B[i][j])),
        mul: (A, B) => A.map(row => B[0].map((_, i) => row.reduce((s, _, j) => s + row[j] * B[j][i], 0))),
        det: (m) => {
            if (m.length !== m[0].length) return "No cuadrada";
            if (m.length === 1) return m[0][0];
            if (m.length === 2) return m[0][0]*m[1][1] - m[0][1]*m[1][0];
            return m[0].reduce((d, c, i) => d + (i % 2 ? -1 : 1) * c * MathOps.det(m.slice(1).map(row => row.filter((_, j) => j !== i))), 0);
        }
    };

    function executeCalculation() {
        const input = document.getElementById('op-input').value.toUpperCase().replace(/\s/g, '');
        const resSection = document.getElementById('res-section');
        const resData = document.getElementById('res-data');
        
        let result = "Ingresa una operación (ej: A+B)";
        try {
            const A = getMatrixData("A");
            const B = matrixNames.includes("B") ? getMatrixData("B") : null;

            if (input === "A+B" && B) result = MathOps.add(A, B);
            else if (input === "A*B" && B) result = MathOps.mul(A, B);
            else if (input.includes("DET(")) {
                const n = input.match(/\(([^)]+)\)/)[1];
                result = "Determinante: " + MathOps.det(getMatrixData(n));
            } else {
                result = A; // Por defecto mostrar A
            }
        } catch(e) { result = "Error en la operación"; }

        lastResult = Array.isArray(result) ? result : null;
        resData.innerHTML = Array.isArray(result) ? 
            result.map(r => `[ ${r.join(' | ')} ]`).join('<br>') : result;
        resSection.style.display = "block";
        updateView();
    }

    function updateView() {
        const target = document.getElementById('graph-select').value;
        const type = document.getElementById('graph-type').value;
        let dataToDraw = (target === "RES" && lastResult) ? lastResult : getMatrixData(target === "RES" ? "A" : target);
        draw(dataToDraw, type);
    }

    function draw(m, type) {
        const traces = [];
        const watermark = {
            text: "√(Raiz) Cuadrada²", xref: "paper", yref: "paper", x: 0.95, y: 0.05,
            showarrow: false, font: { family: "Playfair Display", size: 16, color: "#eee", weight: "bold" }
        };

        if (type === '2d') {
            const v1 = [m[0][0]||0, (m[1]?m[1][0]:0)];
            const v2 = [m[0][1]||0, (m[1]?m[1][1]:0)];
            traces.push({
                x: [0, v1[0], v1[0]+v2[0], v2[0], 0],
                y: [0, v1[1], v1[1]+v2[1], v2[1], 0],
                fill: 'toself', type: 'scatter', mode: 'lines+markers',
                fillcolor: 'rgba(0,0,0,0.1)', line: {color: 'black', width: 2}
            });
        } else {
            // MEJORA 3D: Paralelepípedo sólido con Mesh3d para entender el volumen
            const v1 = [m[0][0]||0, (m[1]?m[1][0]:0), (m[2]?m[2][0]:0)];
            const v2 = [m[0][1]||0, (m[1]?m[1][1]:0), (m[2]?m[2][1]:0)];
            const v3 = [m[0][2]||0, (m[1]?m[1][2]:0), (m[2]?m[2][2]:0)];

            // 8 Vértices
            const pts = [
                [0,0,0], v1, v2, v3, 
                [v1[0]+v2[0], v1[1]+v2[1], v1[2]+v2[2]],
                [v1[0]+v3[0], v1[1]+v3[1], v1[2]+v3[2]],
                [v2[0]+v3[0], v2[1]+v3[1], v2[2]+v3[2]],
                [v1[0]+v2[0]+v3[0], v1[1]+v2[1]+v3[1], v1[2]+v2[2]+v3[2]]
            ];

            traces.push({
                type: 'mesh3d',
                x: pts.map(p => p[0]), y: pts.map(p => p[1]), z: pts.map(p => p[2]),
                alphahull: 0, opacity: 0.2, color: 'black'
            });

            // Aristas para definición
            const lines = [
                [0,1], [0,2], [0,3], [1,4], [1,5], [2,4], [2,6], [3,5], [3,6], [4,8], [5,8], [6,8]
            ];
            lines.forEach(l => {
                traces.push({
                    type: 'scatter3d', mode: 'lines',
                    x: [pts[l[0]][0], pts[l[1]][0]], y: [pts[l[0]][1], pts[l[1]][1]], z: [pts[l[0]][2], pts[l[1]][2]],
                    line: {color: 'black', width: 4}
                });
            });
        }

        const layout = {
            margin: {l:0, r:0, t:0, b:0}, paper_bgcolor: 'white',
            showlegend: false, annotations: [watermark],
            scene: { xaxis: {title: 'X'}, yaxis: {title: 'Y'}, zaxis: {title: 'Z'} }
        };
        Plotly.newPlot('plot', traces, layout, {responsive: true, displayModeBar: false});
    }

    async function downloadPNG() {
        const plot = document.getElementById('plot');
        await Plotly.relayout(plot, { 'annotations[0].font.size': 60, 'annotations[0].font.color': 'rgba(0,0,0,0.05)' });
        await Plotly.downloadImage(plot, { format: 'png', width: 1200, height: 900, filename: 'calculo_matricial' });
        Plotly.relayout(plot, { 'annotations[0].font.size': 16, 'annotations[0].font.color': '#eee' });
    }

    function toggleGuide(show) {
        document.getElementById('guide-modal').style.display = show ? 'flex' : 'none';
    }

    window.onload = init;
</script>
</body>
</html>
