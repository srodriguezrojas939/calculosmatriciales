<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo Matriciales - √(Raiz) Cuadrada²</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap');

        :root {
            --bg-gray: #F2F2F2;
            --white: #FFFFFF;
            --black: #000000;
            --border: #DDDDDD;
            --dark-gray: #333333;
            --light-gray: #E0E0E0;
        }

        body { 
            background: white; 
            font-family: 'Open Sans', sans-serif; 
            margin: 0;
            display: flex; 
            justify-content: center; 
            padding: 15px; 
            color: var(--dark-gray);
        }

        .container { 
            max-width: 1100px; 
            width: 100%; 
            padding: 30px; 
            background: var(--bg-gray); 
            border-radius: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); 
        }

        h1, h2, h3, .matrix-name { font-family: 'Playfair Display', serif; font-weight: 700; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 34px; margin: 0; }
        .header p { font-size: 18px; font-weight: 700; font-family: 'Playfair Display'; margin: 5px 0; }

        /* GESTIÓN DE MATRICES */
        .matrix-manager { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }

        .matrix-card { 
            background: var(--white); 
            padding: 20px; 
            border-radius: 30px; 
            border: 1px solid var(--border); 
            position: relative;
        }

        .matrix-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .matrix-name { font-size: 26px; }
        
        .btn-delete { 
            background: var(--black); color: var(--white); border: none; 
            width: 28px; height: 28px; border-radius: 50%; 
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .btn-delete:hover { background: var(--dark-gray); }

        .matrix-controls { display: flex; gap: 8px; align-items: center; margin-bottom: 15px; font-size: 13px; font-weight: 600; }
        .matrix-controls input { 
            width: 40px; padding: 4px; border-radius: 8px; border: 1px solid var(--light-gray); text-align: center; font-weight: 600;
        }

        .matrix-grid { display: grid; gap: 6px; justify-content: center; }
        .matrix-grid input { 
            width: 55px; height: 45px; text-align: center; border-radius: 12px; 
            border: 1px solid #f0f0f0; background: #fafafa; font-weight: 600; font-size: 15px;
        }

        /* SECCIÓN OPERACIONES */
        .ops-section { background: var(--white); padding: 25px; border-radius: 35px; border: 1px solid var(--border); margin-bottom: 30px; }
        .pill-input { 
            width: 100%; padding: 18px 25px; border-radius: 50px; border: 1px solid #e0e0e0; 
            font-size: 16px; font-weight: 600; box-sizing: border-box; outline: none;
        }

        .btn-main { 
            width: 100%; padding: 18px; background: var(--black); color: var(--white); 
            border: none; border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 15px; transition: 0.3s; 
        }

        /* DASHBOARD DE DATOS Y RESULTADOS */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        .res-card { background: var(--white); padding: 25px; border-radius: 30px; border: 1px solid var(--border); height: 100%; box-sizing: border-box; }
        .res-card.highlight { border: 2px solid var(--black); }
        .res-card h2 { margin-top: 0; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .res-content { font-size: 15px; font-weight: 600; line-height: 1.6; color: var(--dark-gray); }

        /* GRÁFICAS */
        .graph-wrapper { background: var(--white); border-radius: 40px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 30px; position: relative; }
        .graph-tools { 
            padding: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; 
            border-bottom: 1px solid #f0f0f0; background: #fafafa;
        }
        .select-pill { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; background: white; font-weight: 600; cursor: pointer; }
        
        #plot { height: 500px; width: 100%; }

        /* BOTONES ACCIÓN */
        .action-bar { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .pill-btn-white { 
            background: var(--white); border: 1px solid #e0e0e0; border-radius: 50px; 
            padding: 12px 30px; display: flex; align-items: center; gap: 10px; 
            cursor: pointer; font-weight: 700; transition: 0.3s;
        }
        .pill-btn-white:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.06); }

        /* MODAL GUÍA */
        #guide-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content { 
            background: white; padding: 40px; border-radius: 40px; max-width: 600px; width: 100%; 
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .close-modal { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 24px; font-weight: bold; }

        @media (max-width: 800px) {
            .dashboard { grid-template-columns: 1fr; }
            #plot { height: 350px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Cálculo Matriciales</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div class="matrix-manager" id="manager"></div>
    
    <div style="text-align: center; margin-bottom: 25px;">
        <button class="pill-btn-white" onclick="addNewMatrix()">+ Añadir Matriz</button>
    </div>

    <div class="ops-section">
        <input type="text" id="op-input" class="pill-input" placeholder="Ej: A + B, A * B, Det(A) + Det(B)...">
        <button class="btn-main" onclick="processAll()">Ejecutar Acción</button>
    </div>

    <div class="dashboard">
        <div class="res-card">
            <h2 id="basic-data-title">Datos Básicos: Matriz A</h2>
            <div id="basic-data-content" class="res-content">
                Cargando datos...
            </div>
        </div>
        <div class="res-card highlight">
            <h2>Resultado de Operación</h2>
            <div id="op-result-content" class="res-content">
                Esperando comando...
            </div>
        </div>
    </div>

    <div class="graph-wrapper">
        <div class="graph-tools">
            <span style="font-weight: 600;">Seleccionar para Análisis:</span>
            <select id="graph-select" class="select-pill" onchange="updateView()"></select>
            <select id="graph-type" class="select-pill" onchange="updateView()">
                <option value="2d">Determinante 2D</option>
                <option value="3d" selected>Determinante 3D</option>
            </select>
        </div>
        <div id="plot"></div>
    </div>

    <div class="action-bar">
        <button class="pill-btn-white" onclick="downloadPNG()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Descargar PNG
        </button>
        <button class="pill-btn-white" onclick="toggleGuide(true)">Guía de uso</button>
    </div>
</div>

<div id="guide-modal" onclick="toggleGuide(false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="toggleGuide(false)">&times;</span>
        <h2>Guía de Uso</h2>
        <p>Utiliza los nombres de las matrices (A, B, C...) para operar:</p>
        <ul style="line-height: 1.8;">
            <li><strong>Suma/Resta:</strong> A + B, A - B</li>
            <li><strong>Multiplicación:</strong> A * B</li>
            <li><strong>Combinaciones:</strong> Det(A) + Det(B)</li>
            <li><strong>Inversa:</strong> Inv(A)</li>
            <li><strong>Transpuesta:</strong> Trans(A)</li>
        </ul>
        <p>El recuadro <strong>Datos Básicos</strong> se actualiza automáticamente al cambiar la matriz en el selector de la gráfica.</p>
    </div>
</div>

<script>
    let matrixNames = ["A"];
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let lastOpResult = null;

    function init() {
        addNewMatrix("A");
        addNewMatrix("B");
        processAll();
    }

    function addNewMatrix(fixedName = null) {
        const name = fixedName || alphabet[matrixNames.length];
        if (matrixNames.includes(name) && !fixedName) return;
        if (!fixedName) matrixNames.push(name);

        const manager = document.getElementById('manager');
        const card = document.createElement('div');
        card.className = 'matrix-card';
        card.id = `card-${name}`;
        
        const deleteBtn = name === "A" ? "" : `<button class="btn-delete" onclick="removeMatrix('${name}')">&times;</button>`;

        card.innerHTML = `
            <div class="matrix-header">
                <div class="matrix-name">${name}</div>
                ${deleteBtn}
            </div>
            <div class="matrix-controls">
                <input type="number" value="3" min="1" max="6" id="r-${name}" onchange="renderGrid('${name}')"> x 
                <input type="number" value="3" min="1" max="6" id="c-${name}" onchange="renderGrid('${name}')">
            </div>
            <div id="grid-${name}" class="matrix-grid"></div>
        `;
        manager.appendChild(card);
        renderGrid(name);
        updateSelects();
    }

    function removeMatrix(name) {
        matrixNames = matrixNames.filter(n => n !== name);
        document.getElementById(`card-${name}`).remove();
        updateSelects();
        processAll();
    }

    function renderGrid(name) {
        const r = document.getElementById(`r-${name}`).value;
        const c = document.getElementById(`c-${name}`).value;
        const grid = document.getElementById(`grid-${name}`);
        grid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
        let html = '';
        for (let i = 0; i < r * c; i++) {
            let val = (i % (parseInt(c)+1) === 0) ? 1 : 0;
            html += `<input type="number" value="${val}" class="val-${name}" onchange="processAll()">`;
        }
        grid.innerHTML = html;
    }

    function getMatrixData(name) {
        const r = parseInt(document.getElementById(`r-${name}`).value);
        const c = parseInt(document.getElementById(`c-${name}`).value);
        const inputs = document.querySelectorAll(`.val-${name}`);
        let data = [];
        for (let i = 0; i < r; i++) {
            let row = [];
            for (let j = 0; j < c; j++) row.push(parseFloat(inputs[i * c + j].value) || 0);
            data.push(row);
        }
        return data;
    }

    function updateSelects() {
        const sel = document.getElementById('graph-select');
        const current = sel.value;
        sel.innerHTML = matrixNames.map(n => `<option value="${n}">Matriz ${n}</option>`).join('');
        sel.innerHTML += `<option value="RES">Resultado de Operación</option>`;
        sel.value = current || "A";
    }

    const Linear = {
        det: (m) => {
            if (m.length !== m[0].length) return null;
            if (m.length === 1) return m[0][0];
            if (m.length === 2) return m[0][0]*m[1][1] - m[0][1]*m[1][0];
            return m[0].reduce((d, c, i) => d + (i % 2 ? -1 : 1) * c * Linear.det(m.slice(1).map(row => row.filter((_, j) => j !== i))), 0);
        },
        rank: (m) => {
            let mat = m.map(r => [...r]);
            let r = mat.length, c = mat[0].length, rank = 0;
            for (let i = 0; i < Math.min(r, c); i++) {
                let pivot = i;
                while (pivot < r && Math.abs(mat[pivot][i]) < 1e-9) pivot++;
                if (pivot < r) {
                    [mat[i], mat[pivot]] = [mat[pivot], mat[i]];
                    for (let j = i + 1; j < r; j++) {
                        let f = mat[j][i] / mat[i][i];
                        for (let k = i; k < c; k++) mat[j][k] -= f * mat[i][k];
                    }
                    rank++;
                }
            }
            return rank;
        },
        inv: (m) => {
            let d = Linear.det(m);
            if (!d || d === 0) return null;
            const size = m.length;
            let adj = [];
            for (let i = 0; i < size; i++) {
                let row = [];
                for (let j = 0; j < size; j++) {
                    let minor = m.filter((_, r) => r !== i).map(r => r.filter((_, c) => c !== j));
                    row.push(((i + j) % 2 === 0 ? 1 : -1) * Linear.det(minor));
                }
                adj.push(row);
            }
            return adj[0].map((_, c) => adj.map(r => r[c] / d));
        }
    };

    function processAll() {
        // 1. Calcular Operación
        const input = document.getElementById('op-input').value.toUpperCase().replace(/\s/g, '');
        const opResDiv = document.getElementById('op-result-content');
        
        try {
            if (input.includes("+")) {
                const parts = input.split("+");
                const m1 = getMatrixData(parts[0]), m2 = getMatrixData(parts[1]);
                lastOpResult = m1.map((r, i) => r.map((v, j) => v + m2[i][j]));
            } else if (input.includes("*")) {
                const parts = input.split("*");
                const m1 = getMatrixData(parts[0]), m2 = getMatrixData(parts[1]);
                lastOpResult = m1.map(row => m2[0].map((_, i) => row.reduce((s, _, j) => s + row[j] * m2[j][i], 0)));
            } else {
                lastOpResult = null;
            }
        } catch(e) { lastOpResult = "Error en operación"; }

        opResDiv.innerHTML = Array.isArray(lastOpResult) ? 
            lastOpResult.map(r => `[ ${r.map(v=>v.toFixed(1)).join(' | ')} ]`).join('<br>') : (lastOpResult || "Sin operación");

        updateView();
    }

    function updateView() {
        const target = document.getElementById('graph-select').value;
        const type = document.getElementById('graph-type').value;
        const basicTitle = document.getElementById('basic-data-title');
        const basicContent = document.getElementById('basic-data-content');

        let data = (target === "RES") ? lastOpResult : getMatrixData(target);
        
        if (!data || typeof data === "string") {
            basicContent.innerHTML = "Sin datos válidos.";
            return;
        }

        basicTitle.innerText = `Datos Básicos: ${target === "RES" ? "Resultado" : "Matriz " + target}`;
        
        const d = Linear.det(data);
        const r = Linear.rank(data);
        const i = Linear.inv(data);

        basicContent.innerHTML = `
            <strong>Determinante:</strong> ${d !== null ? d.toFixed(2) : "N/A"}<br>
            <strong>Rango:</strong> ${r}<br>
            <strong>Inversa:</strong><br>
            ${i ? i.map(row => `[${row.map(v=>v.toFixed(2)).join('|')}]`).join('<br>') : "No existe (Det=0 o no cuadrada)"}
        `;

        draw(data, type);
    }

    function draw(m, type) {
        const traces = [];
        if (type === '2d') {
            const v1 = [m[0][0]||0, (m[1]?m[1][0]:0)];
            const v2 = [m[0][1]||0, (m[1]?m[1][1]:0)];
            traces.push({
                x: [0, v1[0], v1[0]+v2[0], v2[0], 0],
                y: [0, v1[1], v1[1]+v2[1], v2[1], 0],
                fill: 'toself', type: 'scatter', mode: 'lines+markers',
                fillcolor: 'rgba(0,0,0,0.1)', line: {color: 'black', width: 2}
            });
        } else {
            // 3D MEJORADO: Paralelepípedo
            const v = [
                [m[0][0]||0, (m[1]?m[1][0]:0), (m[2]?m[2][0]:0)],
                [m[0][1]||0, (m[1]?m[1][1]:0), (m[2]?m[2][1]:0)],
                [m[0][2]||0, (m[1]?m[1][2]:0), (m[2]?m[2][2]:0)]
            ];

            const pts = [
                [0,0,0], v[0], v[1], v[2],
                [v[0][0]+v[1][0], v[0][1]+v[1][1], v[0][2]+v[1][2]],
                [v[0][0]+v[2][0], v[0][1]+v[2][1], v[0][2]+v[2][2]],
                [v[1][0]+v[2][0], v[1][1]+v[2][1], v[1][2]+v[2][2]],
                [v[0][0]+v[1][0]+v[2][0], v[0][1]+v[1][1]+v[2][1], v[0][2]+v[1][2]+v[2][2]]
            ];

            traces.push({
                type: 'mesh3d',
                x: pts.map(p => p[0]), y: pts.map(p => p[1]), z: pts.map(p => p[2]),
                alphahull: 0, opacity: 0.15, color: 'black'
            });

            const edges = [[0,1],[0,2],[0,3],[1,4],[1,5],[2,4],[2,6],[3,5],[3,6],[4,8],[5,8],[6,8]];
            edges.forEach(e => {
                traces.push({
                    type: 'scatter3d', mode: 'lines',
                    x: [pts[e[0]][0], pts[e[1]][0]], y: [pts[e[0]][1], pts[e[1]][1]], z: [pts[e[0]][2], pts[e[1]][2]],
                    line: {color: 'black', width: 4}
                });
            });
        }

        const layout = {
            margin: {l:0, r:0, t:0, b:0}, paper_bgcolor: 'white',
            showlegend: false,
            scene: { xaxis: {showgrid:false}, yaxis: {showgrid:false}, zaxis: {showgrid:false} },
            annotations: [{
                text: "√(Raiz) Cuadrada²", xref: "paper", yref: "paper", x: 0.95, y: 0.05,
                showarrow: false, font: { family: "Playfair Display", size: 16, color: "#eee", weight: "bold" }
            }]
        };
        Plotly.newPlot('plot', traces, layout, {responsive: true, displayModeBar: false});
    }

    async function downloadPNG() {
        const plot = document.getElementById('plot');
        await Plotly.relayout(plot, { 'annotations[0].font.size': 60, 'annotations[0].font.color': 'rgba(0,0,0,0.05)' });
        await Plotly.downloadImage(plot, { format: 'png', width: 1200, height: 900, filename: 'analisis_matricial' });
        Plotly.relayout(plot, { 'annotations[0].font.size': 16, 'annotations[0].font.color': '#eee' });
    }

    function toggleGuide(show) { document.getElementById('guide-modal').style.display = show ? 'flex' : 'none'; }

    window.onload = init;
</script>
</body>
</html>
