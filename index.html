<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo Matriciales - √(Raiz) Cuadrada²</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap');

        :root { --bg-gray: #F2F2F2; --white: #FFFFFF; --black: #000000; --border: #DDDDDD; }

        body { background: white; font-family: 'Open Sans', sans-serif; margin: 0; display: flex; justify-content: center; padding: 15px; color: #333; }
        .container { max-width: 1100px; width: 100%; padding: 30px; background: var(--bg-gray); border-radius: 40px; }

        /* TIPOGRAFÍA */
        h1, h2, h3, .matrix-name { font-family: 'Playfair Display', serif; font-weight: 700; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 34px; margin: 0; }
        .header p { font-size: 18px; font-weight: 700; font-family: 'Playfair Display'; margin: 5px 0; }

        /* GESTIÓN DE MATRICES */
        .matrix-manager { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .matrix-card { background: var(--white); padding: 20px; border-radius: 30px; border: 1px solid var(--border); position: relative; }
        .matrix-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .matrix-name { font-size: 26px; }
        .btn-delete { background: var(--black); color: white; border: none; width: 26px; height: 26px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }

        .matrix-controls { display: flex; gap: 8px; align-items: center; margin-bottom: 15px; font-size: 13px; font-weight: 600; }
        .matrix-controls input { width: 40px; padding: 4px; border-radius: 8px; border: 1px solid #ddd; text-align: center; }
        .matrix-grid { display: grid; gap: 6px; justify-content: center; }
        .matrix-grid input { width: 50px; height: 40px; text-align: center; border-radius: 10px; border: 1px solid #eee; background: #fafafa; font-weight: 600; }

        /* OPERACIONES */
        .ops-section { background: var(--white); padding: 25px; border-radius: 35px; border: 1px solid var(--border); margin-bottom: 30px; }
        .pill-input { width: 100%; padding: 18px 25px; border-radius: 50px; border: 1px solid #e0e0e0; font-size: 16px; font-weight: 600; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; padding: 18px; background: var(--black); color: var(--white); border: none; border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 15px; }

        /* DASHBOARD */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .res-card { background: var(--white); padding: 25px; border-radius: 30px; border: 1px solid var(--border); }
        .res-card.highlight { border: 2px solid var(--black); }
        .res-card h2 { margin-top: 0; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .res-content { font-size: 15px; font-weight: 600; line-height: 1.6; overflow-x: auto; }

        /* GRÁFICAS */
        .graph-wrapper { background: var(--white); border-radius: 40px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .graph-tools { padding: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-bottom: 1px solid #f0f0f0; background: #fafafa; }
        #plot { height: 500px; width: 100%; }

        /* GUÍA DESPLEGABLE */
        .guide-container { display: none; background: white; padding: 30px; border-radius: 30px; border: 1px solid #ddd; margin-top: 15px; text-align: left; }
        .guide-container h3 { margin-top: 0; }

        .action-bar { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        .pill-btn-white { background: var(--white); border: 1px solid #e0e0e0; border-radius: 50px; padding: 12px 30px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 700; }

        @media (max-width: 800px) { .dashboard { grid-template-columns: 1fr; } #plot { height: 350px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Cálculo Matriciales</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div class="matrix-manager" id="manager"></div>
    
    <div style="text-align: center; margin-bottom: 25px;">
        <button class="pill-btn-white" onclick="addNewMatrix()">+ Añadir Matriz</button>
    </div>

    <div class="ops-section">
        <input type="text" id="op-input" class="pill-input" placeholder="Ej: A + B, Inv(A), Trans(B), Det(A) + Det(B), Resolver(A, B)">
        <button class="btn-main" onclick="executeOp()">Ejecutar Acción</button>
    </div>

    <div class="dashboard">
        <div class="res-card">
            <h2 id="basic-title">Datos Básicos: A</h2>
            <div id="basic-content" class="res-content">Selecciona una matriz...</div>
        </div>
        <div class="res-card highlight">
            <h2>Resultado de Operación</h2>
            <div id="op-content" class="res-content">Esperando comando...</div>
        </div>
    </div>

    <div class="graph-wrapper">
        <div class="graph-tools">
            <span style="font-weight: 600;">Analizar:</span>
            <select id="graph-select" class="pill-input" style="width: auto; padding: 8px 15px;" onchange="updateUI()"></select>
            <select id="graph-type" class="pill-input" style="width: auto; padding: 8px 15px;" onchange="updateUI()">
                <option value="2d">Vista 2D (Área)</option>
                <option value="3d" selected>Vista 3D (Volumen)</option>
            </select>
        </div>
        <div id="plot"></div>
    </div>

    <div class="action-bar">
        <button class="pill-btn-white" onclick="downloadPNG()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Descargar PNG
        </button>
        <button class="pill-btn-white" onclick="toggleGuide()">Guía de uso</button>
    </div>

    <div id="guide-section" class="guide-container">
        <h3>Guía de Comandos</h3>
        <p style="font-family: 'Open Sans';">Escribe los comandos en el recuadro superior respetando las mayúsculas:</p>
        <ul style="line-height: 2;">
            <li><strong>A + B</strong>: Suma de matrices.</li>
            <li><strong>A * B</strong>: Multiplicación.</li>
            <li><strong>Inv(A)</strong>: Matriz inversa.</li>
            <li><strong>Trans(A)</strong>: Transpuesta.</li>
            <li><strong>Det(A)</strong>: Valor numérico del determinante.</li>
            <li><strong>Resolver(A, B)</strong>: Resuelve el sistema AX = B (B debe ser una matriz de una columna).</li>
        </ul>
    </div>
</div>

<script>
    let matrixNames = [];
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let lastResult = null;

    // --- CORRECCIÓN DE NOMBRES ---
    function getNextLetter() {
        for (let char of alphabet) {
            if (!matrixNames.includes(char)) return char;
        }
        return "?";
    }

    function addNewMatrix(name = null) {
        const letter = name || getNextLetter();
        if (matrixNames.includes(letter)) return;
        
        matrixNames.push(letter);
        matrixNames.sort();

        const card = document.createElement('div');
        card.className = 'matrix-card';
        card.id = `card-${letter}`;
        const delBtn = letter === 'A' ? '' : `<button class="btn-delete" onclick="removeMatrix('${letter}')">×</button>`;

        card.innerHTML = `
            <div class="matrix-header"><span class="matrix-name">${letter}</span>${delBtn}</div>
            <div class="matrix-controls">
                <input type="number" value="3" min="1" max="5" id="r-${letter}" onchange="renderGrid('${letter}')"> x 
                <input type="number" value="3" min="1" max="5" id="c-${letter}" onchange="renderGrid('${letter}')">
            </div>
            <div id="grid-${letter}" class="matrix-grid"></div>
        `;
        document.getElementById('manager').appendChild(card);
        renderGrid(letter);
        updateSelectOptions();
    }

    function removeMatrix(letter) {
        matrixNames = matrixNames.filter(l => l !== letter);
        document.getElementById(`card-${letter}`).remove();
        updateSelectOptions();
        updateUI();
    }

    function renderGrid(letter) {
        const r = document.getElementById(`r-${letter}`).value;
        const c = document.getElementById(`c-${letter}`).value;
        const grid = document.getElementById(`grid-${letter}`);
        grid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
        let html = '';
        for (let i = 0; i < r * c; i++) {
            let val = (i % (parseInt(c)+1) === 0) ? 1 : 0;
            html += `<input type="number" value="${val}" class="val-${letter}" onchange="updateUI()">`;
        }
        grid.innerHTML = html;
        updateUI();
    }

    function getMatrix(letter) {
        const r = parseInt(document.getElementById(`r-${letter}`).value);
        const c = parseInt(document.getElementById(`c-${letter}`).value);
        const inputs = document.querySelectorAll(`.val-${letter}`);
        let data = [];
        for (let i = 0; i < r; i++) {
            let row = [];
            for (let j = 0; j < c; j++) row.push(parseFloat(inputs[i * c + j].value) || 0);
            data.push(row);
        }
        return data;
    }

    // --- MOTOR MATEMÁTICO ---
    const MathLib = {
        det: (m) => {
            if (m.length !== m[0].length) return null;
            if (m.length === 1) return m[0][0];
            if (m.length === 2) return m[0][0]*m[1][1] - m[0][1]*m[1][0];
            return m[0].reduce((d, c, i) => d + (i % 2 ? -1 : 1) * c * MathLib.det(m.slice(1).map(r => r.filter((_, j) => j !== i))), 0);
        },
        trans: (m) => m[0].map((_, i) => m.map(row => row[i])),
        add: (a, b) => a.map((r, i) => r.map((v, j) => v + b[i][j])),
        mul: (a, b) => a.map(r => b[0].map((_, i) => r.reduce((s, _, j) => s + r[j] * b[j][i], 0))),
        inv: (m) => {
            let d = MathLib.det(m); if (!d) return null;
            const size = m.length;
            let adj = m.map((_, i) => m.map((_, j) => {
                let minor = m.filter((_, r) => r !== i).map(r => r.filter((_, c) => c !== j));
                return ((i+j)%2===0?1:-1) * MathLib.det(minor);
            }));
            return MathLib.trans(adj).map(r => r.map(v => v/d));
        },
        rank: (m) => {
            let mat = m.map(r => [...r]);
            let r = mat.length, c = mat[0].length, rank = 0;
            for (let i = 0; i < Math.min(r, c); i++) {
                let pivot = i;
                while (pivot < r && Math.abs(mat[pivot][i]) < 1e-9) pivot++;
                if (pivot < r) {
                    [mat[i], mat[pivot]] = [mat[pivot], mat[i]];
                    for (let j = i + 1; j < r; j++) {
                        let f = mat[j][i] / mat[i][i];
                        for (let k = i; k < c; k++) mat[j][k] -= f * mat[i][k];
                    }
                    rank++;
                }
            }
            return rank;
        },
        solve: (a, b) => {
            let ai = MathLib.inv(a);
            return ai ? MathLib.mul(ai, b) : "Sin solución única";
        }
    };

    function executeOp() {
        const raw = document.getElementById('op-input').value.trim();
        const out = document.getElementById('op-content');
        try {
            let result;
            if (raw.includes('+')) {
                const p = raw.split('+'); result = MathLib.add(getMatrix(p[0].trim()), getMatrix(p[1].trim()));
            } else if (raw.includes('*')) {
                const p = raw.split('*'); result = MathLib.mul(getMatrix(p[0].trim()), getMatrix(p[1].trim()));
            } else if (raw.startsWith('Inv(')) {
                result = MathLib.inv(getMatrix(raw.match(/\(([^)]+)\)/)[1]));
            } else if (raw.startsWith('Trans(')) {
                result = MathLib.trans(getMatrix(raw.match(/\(([^)]+)\)/)[1]));
            } else if (raw.startsWith('Det(')) {
                result = "Determinante: " + MathLib.det(getMatrix(raw.match(/\(([^)]+)\)/)[1])).toFixed(2);
            } else if (raw.startsWith('Resolver(')) {
                const p = raw.match(/\(([^)]+)\)/)[1].split(',');
                result = MathLib.solve(getMatrix(p[0].trim()), getMatrix(p[1].trim()));
            } else { result = "Comando no reconocido"; }

            lastResult = Array.isArray(result) ? result : null;
            out.innerHTML = Array.isArray(result) ? result.map(r => `[ ${r.map(v=>v.toFixed(2)).join(' | ')} ]`).join('<br>') : result;
        } catch(e) { out.innerHTML = "Error: Verifica tamaños o nombres"; }
        updateUI();
    }

    // --- CORRECCIÓN 3D Y UI ---
    function updateUI() {
        const target = document.getElementById('graph-select').value;
        const type = document.getElementById('graph-type').value;
        let data = (target === "RES") ? lastResult : getMatrix(target || "A");

        if (data && target !== "RES") {
            const d = MathLib.det(data);
            document.getElementById('basic-title').innerText = `Datos Básicos: ${target}`;
            document.getElementById('basic-content').innerHTML = `
                Det: ${d !== null ? d.toFixed(2) : 'N/A'} | Rango: ${MathLib.rank(data)}<br>
                Inversa:<br>${MathLib.inv(data) ? MathLib.inv(data).map(r => `[${r.map(v=>v.toFixed(1)).join('|')}]`).join('<br>') : 'No existe'}
            `;
        }
        if (data) drawGraph(data, type);
    }

    function drawGraph(m, type) {
        const traces = [];
        if (type === '2d') {
            const v1 = [m[0][0]||0, m[1]?m[1][0]:0], v2 = [m[0][1]||0, m[1]?m[1][1]:0];
            traces.push({ x: [0, v1[0], v1[0]+v2[0], v2[0], 0], y: [0, v1[1], v1[1]+v2[1], v2[1], 0], fill: 'toself', type: 'scatter', line: {color: 'black'} });
        } else {
            // VOLUMEN 3D REAL (Paralelepípedo)
            const v1 = [m[0][0]||0, m[1]?m[1][0]:0, m[2]?m[2][0]:0];
            const v2 = [m[0][1]||0, m[1]?m[1][1]:0, m[2]?m[2][1]:0];
            const v3 = [m[0][2]||0, m[1]?m[1][2]:0, m[2]?m[2][2]:0];

            const p = [[0,0,0], v1, v2, v3, 
                [v1[0]+v2[0], v1[1]+v2[1], v1[2]+v2[2]], 
                [v1[0]+v3[0], v1[1]+v3[1], v1[2]+v3[2]], 
                [v2[0]+v3[0], v2[1]+v3[1], v2[2]+v3[2]], 
                [v1[0]+v2[0]+v3[0], v1[1]+v2[1]+v3[1], v1[2]+v2[2]+v3[2]]];

            traces.push({ type: 'mesh3d', x: p.map(a=>a[0]), y: p.map(a=>a[1]), z: p.map(a=>a[2]), alphahull: 0, opacity: 0.2, color: 'black' });
            const edges = [[0,1],[0,2],[0,3],[1,4],[1,5],[2,4],[2,6],[3,5],[3,6],[4,8],[5,8],[6,8]];
            edges.forEach(e => traces.push({ type: 'scatter3d', mode: 'lines', x:[p[e[0]][0], p[e[1]][0]], y:[p[e[0]][1], p[e[1]][1]], z:[p[e[0]][2], p[e[1]][2]], line:{color:'black', width:4} }));
        }

        const layout = { 
            margin:{l:0,r:0,t:0,b:0}, paper_bgcolor:'white', showlegend:false,
            scene: { xaxis:{title:'X'}, yaxis:{title:'Y'}, zaxis:{title:'Z'} },
            annotations: [{ text: "√(Raiz) Cuadrada²", xref: "paper", yref: "paper", x: 0.95, y: 0.05, showarrow: false, font: { family: "Playfair Display", size: 16, color: "#eee", weight: "bold" } }]
        };
        Plotly.newPlot('plot', traces, layout, {responsive: true, displayModeBar: false});
    }

    function updateSelectOptions() {
        const s = document.getElementById('graph-select');
        const val = s.value;
        s.innerHTML = matrixNames.map(n => `<option value="${n}">Matriz ${n}</option>`).join('') + `<option value="RES">Resultado</option>`;
        if (matrixNames.includes(val) || val === "RES") s.value = val;
    }

    function toggleGuide() {
        const g = document.getElementById('guide-section');
        g.style.display = g.style.display === 'block' ? 'none' : 'block';
    }

    async function downloadPNG() {
        const plot = document.getElementById('plot');
        await Plotly.relayout(plot, { 'annotations[0].font.size': 60, 'annotations[0].font.color': 'rgba(0,0,0,0.05)' });
        await Plotly.downloadImage(plot, { format: 'png', width: 1200, height: 900, filename: 'analisis_matricial' });
        Plotly.relayout(plot, { 'annotations[0].font.size': 16, 'annotations[0].font.color': '#eee' });
    }

    window.onload = () => { addNewMatrix("A"); addNewMatrix("B"); };
</script>
</body>
</html>
